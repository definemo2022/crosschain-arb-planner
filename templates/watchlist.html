<!DOCTYPE html>
<html>
<head>
    <title>Watchlist Manager</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .pair { margin: 10px 0; padding: 10px; background-color: #f0f0f0; }
        .form-group { margin: 10px 0; }
        label { display: inline-block; width: 100px; }
        select, input { width: 200px; padding: 5px; }
        button { margin: 5px; padding: 5px 10px; }
    </style>
</head>
<body>
    <h1>Watchlist Manager</h1>
    
    <div id="add-pair">
        <h2>Add New Pair</h2>
        <div class="form-group">
            <label>From Chain:</label>
            <select id="fromChain">
                {{CHAIN_OPTIONS}}
            </select>
        </div>
        
        <div class="form-group">
            <label>Token A:</label>
            <select id="tokenA"></select>
        </div>
        
        <div class="form-group">
            <label>To Chain:</label>
            <select id="toChain">
                {{CHAIN_OPTIONS}}
            </select>
        </div>
        
        <div class="form-group">
            <label>Token B:</label>
            <select id="tokenB"></select>
        </div>
        
        <div class="form-group">
            <label>Base Amount:</label>
            <input type="number" id="baseAmount" value="1000.0" step="0.1">
        </div>
        
        <button onclick="addPair()">Add Pair</button>
    </div>

    <div id="error" style="color: red;"></div>

    <h2>Current Pairs</h2>
    <div id="pairs">
        {{CURRENT_PAIRS}}
    </div>

    <script>
        // Global token map - initialized as empty object
        var tokenMap = {};
        
        // Initialize data safely by parsing JSON string
        function initData() {
            try {
                tokenMap = JSON.parse('{{{TOKEN_MAP}}}');
                console.log('Token map initialized:', tokenMap);
                updateTokenList('fromChain', 'tokenA');
                updateTokenList('toChain', 'tokenB');
            } catch (e) {
                console.error('Failed to initialize token map:', e);
                document.getElementById('error').textContent = 'Failed to load token data';
            }
        }

        function updateTokenList(chainSelectId, tokenSelectId) {
            try {
                const chain = document.getElementById(chainSelectId).value;
                const tokenSelect = document.getElementById(tokenSelectId);
                tokenSelect.innerHTML = '';
                
                console.log('Updating tokens for chain:', chain);
                const tokens = tokenMap[chain] || [];
                console.log('Available tokens:', tokens);
                
                tokens.forEach(token => {
                    const option = document.createElement('option');
                    option.value = token;
                    option.text = token;
                    tokenSelect.appendChild(option);
                });
            } catch (e) {
                console.error('Error updating token list:', e);
            }
        }

        // Initialize when page loads
        window.addEventListener('load', initData);

        // Add change event listeners when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('fromChain').addEventListener('change', function() {
                updateTokenList('fromChain', 'tokenA');
            });
            
            document.getElementById('toChain').addEventListener('change', function() {
                updateTokenList('toChain', 'tokenB');
            });
        });

        async function addPair() {
            const pair = {
                A_chain: document.getElementById('fromChain').value,
                B_chain: document.getElementById('toChain').value,
                A: document.getElementById('tokenA').value,
                B: document.getElementById('tokenB').value,
                base: parseFloat(document.getElementById('baseAmount').value)
            };

            try {
                const response = await fetch('/api/pairs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(pair)
                });

                const result = await response.json();
                if (result.status === 'success') {
                    window.location.reload();
                } else {
                    document.getElementById('error').textContent = result.message;
                }
            } catch (e) {
                document.getElementById('error').textContent = 'Error adding pair';
            }
        }

        async function deletePair(index) {
            try {
                const response = await fetch(`/api/pairs/${index}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                if (result.status === 'success') {
                    window.location.reload();
                } else {
                    document.getElementById('error').textContent = result.message;
                }
            } catch (e) {
                document.getElementById('error').textContent = 'Error deleting pair';
            }
        }
    </script>
</body>
</html>